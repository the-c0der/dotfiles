# issue:test

GitHub Issue #\$ARGUMENTS 测试代码生成指令

### 0 · 前置条件

- 已安装并登录 GitHub CLI (`gh`)。
- 项目已配置并确定主要测试框架（例如 **pytest**、**Jest**、**Go testing** 等）。

### 1 · 获取验收指标

1. 读取 Issue #\$ARGUMENTS 的描述及 **Acceptance Criteria**（若由 `/project:issue-plan` 自动生成，可直接引用该部分）。
2. **think harder** 深度理解每一条验收规则与失败条件。
3. 列出要验证的行为清单（Given / When / Then）。

### 2 · 测试策略

- 目标：**让任何不满足验收指标的实现都必定触发失败**。
- 覆盖：受影响代码行数 ≥90% 语句覆盖，并最小化冗余。
- 多维度测试：

  1. **正向路径**：确保功能在理想输入下通过。
  2. **边界与异常**：探索最小/最大、空值、非法输入。
  3. **属性/不变量**（Property‑Based）测试：使用 `hypothesis` / `fast-check` 等生成随机输入，验证不变量。
  4. **并发与时序**（如适用）：检测竞态、锁超时、回调次序。
  5. **安全 & 权限**（如适用）：验证拒绝未授权访问。

- Agentic Loop：允许测试代理在首次失败后**迭代生成**更多测试，提高覆盖率。

### 3 · AI 编写测试常见缺陷自检

> 编写测试前后务必对照此表；如未通过自检，循环修正后再输出最终补丁。

| 缺陷类别          | 典型表现                                  | 避免策略                                                    |
| ----------------- | ----------------------------------------- | ----------------------------------------------------------- |
| **编译/导入错误** | 方法名、模块路径拼写错误导致测试无法运行  | 自动执行 `pytest -q` / `npm test --silent`；确保 0 编译错误 |
| **断言松散**      | 仅检查返回真值，未验证输出内容或副作用    | 增强断言，验证关键字段、状态及副作用                        |
| **测试永远通过**  | 断言逻辑错误，或捕获异常却未重新抛出      | 在注入故障后验证测试会失败（见 Mutation 步骤）              |
| **缺少负面/边界** | 只测试快乐路径                            | 使用 Parametrize & Fuzz 生成多样输入                        |
| **环境依赖**      | 实际访问网络、时钟、随机数 ⇒ 导致脆弱与慢 | 使用 Mock / Stub / FreezeTime / Seed Random                 |
| **顺序依赖**      | 测试之间共享状态                          | 在 `setup/teardown` 清理，保持可并行执行                    |
| **异步/并发问题** | 忽视 Await / Promise，导致假绿            | 使用 async‑aware 测试工具，启用并发跑次确认                 |
| **覆盖不足**      | 仅验证头部 API，未触及错误分支            | 生成附加测试以覆盖异常路径                                  |

### 4 · 具体实现步骤

1. **生成测试骨架**：

   - 文件位置：`tests/test_issue_$ARGUMENTS.py` 或 `__tests__/issue-$ARGUMENTS.spec.ts`。
   - 引入项目现有公共 Fixture & Helper。

2. **实现属性测试**：

   - Python 示例：

     ```python
     from hypothesis import given, strategies as st
     @given(st.text())
     def test_property_xxx(random_input):
         ...
     ```

3. **编写 Mutation 钩子**（QuickCheck / mutmut / stryker）：

   - 运行 Mutation 工具；若全部存活率 < 100%，说明测试可捕获变异。

4. **Agentic 自我检查循环**：

   1. 运行测试 → 通过
   2. 引入随机代码扰动 / toggle feature flag → 测试应失败
   3. 若未失败，AI 自动补充测试并重试，直至满足不变式

5. **生成覆盖率报告** (`--cov`)，确保阈值符合策略。

### 5 · 发布

1. 创建分支：`test/issue-$ARGUMENTS`。
2. 将测试文件与覆盖率报告生成脚本一起提交。
3. 打开 Draft PR 并 @mention issue.
4. 在 Issue 评论添加简要总结及测试覆盖率百分比，末尾附：

   ```
   <!-- autogenerated by /project:issue-test -->
   ```

### 6 · 约束

- 不修改生产代码，仅在 `tests/` 或 `__tests__/` 目录增删文件。
- 输出补丁应通过项目的 CI（含 lint / type‑check / test）。
- 若需要安装新测试依赖，先在 PR `requirements-dev.txt` 或 `package.json` 更新，并说明理由。
- 任何无法 mock 的外部服务请模拟端点或使用回环地址。

---

> **Agentic 提示**：若在 Agentic Loop 中出现连续三轮无法提高存活率，可请求人类审阅。
